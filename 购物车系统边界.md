# 购物车

## 1，系统边界

从用户视角来看，购物车模块包括增删改查购物车记录。从功能视角来看，购物车模块是一个用户预购买商品的暂存地，整合了支撑交易功能的底层服务，服务包括商品，满额满件，优惠券。另外购物车还为下单提供了必要的数据。

## 2，依赖和被依赖关系

### 1,依赖
- **同商品的依赖关系**：购物车列表和商品的依赖是最紧密的，以至于在购物车的数据读取类里面直接嵌入了商品数据读取的代码。根据sku_id向商品模块读取sku的详细信息，包括价格，商品名称，库存等。
- **同满额满件的依赖关系**：加载完购物车的主信息（包括商品信息）后，会根据shop_id获取商家设置的满额满件的数据。
- **同优惠券的依赖关系**：根据用户id和购物车商品所属店铺id获取商家所设置的店铺优惠券数据。

### 2,被依赖
- **同下单的依赖关系**：购物车下单时会用到购物车的数据，购物车主表里面的每一条记录（以sid为主键的一条记录）表示一个sku，在订单确认页面或提交订单都会根据sid来获取商品的价格，库存，上下架等数据（实际上，会根据sid再去商品系统取一下数据）。下单完成后，系统会删除掉使用到的sid记录。


## 3,当前模块层次关系

> 整个交易系统的架构是两层结构(sdoota & vdoota), sdoota层的主要作用是发送请求和为各平台（pc & mob）组装数据，vdoota层的主要作用是处理各模块的逻辑和提供数据。

<center>![购物车列表层次结构图](img/cart_desc.png)</center>
<center>图3-1：购物车列表层次结构图</center>
   
  
从购物车列表的层次图中可以看出，vdoota的购物车列表接囗调用了满额满件模块和购物车的主表数据，其中购物车的主表数据内嵌了商品数据的获取逻辑。另外一个和vdoota同层的coupon层提供了优惠券数据。



<center>![购物车下单层次结构图](img/cart_order.png)</center>
<center>图3-2：购物车下单层次结构图</center>

购物车下单的过程中，订单模块会向购物车获取获取下单商品的详细信息，下单成功后删除相应的购物车记录。

## 4,当前业务逻辑流程


- **购物车列表**：如果是已登录用户，从cart.t_bat_shopcart读取用户的购物车数据，未登录读取cart.t_bat_shopcart_offline，然后根据主表数据获取sku和shop的详细数据。遍历用户购物车的每条记录并格式化数据，sku中的数据包括了价格，库存，标题和活动的相关数据。购物车的主要数据加载完成后，根据shop_id获取商家设置的满额满件优惠数据。vdoota层处理完成，把这些数据返回给sdoota。sdoota接收到数据后，向coupon模块发送http请求获取店铺的可领取的店铺优惠券，格式化数据后向hornbill输出数据。

- **向购物车添加商品**：系统首先加载添加商品的sku信息和用户所有的购物车数据，进行入库前的各项检查：上下架，商品属性（颜色尺码）合法性，库存，用户最多可加入的商品数等（相同商品一次只能有100件，购物车最多能有100种sku）。如果用户已经有相同sku商品，则更新amount，否则插入数据。

- **删除购物车商品**：根据sid（购物车每条记录主键）将对应的记录statu设置为-1。

- **更新购物车商品**：系统判断更新后的sku属性购物车里是否存在，如存在则删除更新的sku记录并返回，如不存在则更新相关的数据。

- **更新购物车sku数量**：更新购物车sku数量的参数是：sid_amount，amount是表示要更新到的sku数量，所以如果有两个客户端同时操作加或减，都会以最后执行操作所看到的那个结果为准。

- **获取优惠券提醒**：更新购物车商品和数量的时候，会调用获取购物车店铺优惠券的接囗。取到店铺优惠券数据后，过滤掉不满足条件的记录，组装数据后向hornbill输出数据。

- **订单确认**：购物车在订单确认所起的作用就是读取商品数据。

- **下单**：购物车在订单所起的作用除了读取商品数据外，在下单成功后还需要删除所对应的记录。

## 5,产品现状和规划(todo)

	产品规划和现状从纯产品角度（需要involve PM）阐述了该子系统所承担的产品、运营的业务功能和任务。产品规划有助于在设计新的系统时，为未来的变化做好准备。

	
## 6,当前线上部署、流量、数据量和性能情况（含大促期间 todo）

	当前线上部署情况、流量和性能，以及大促期间的增长情况，阐述各接口的流量（白天平均/高峰）的QPS，以及平均响应耗时，和耗时分布。 同时，需要阐述线上系统的数据量和数据增长情况。 当前线上流量和性能情况有助于在架构演进时在性能、稳定性方面做出恰当的规划和升级
